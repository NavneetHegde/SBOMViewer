@using System.Text.Json
@using System.Text.RegularExpressions
@using Microsoft.FluentUI.AspNetCore.Components
@using SBOMViewer.Blazor.Models

@if (Element.ValueKind == JsonValueKind.Object)
{
    @foreach (var prop in Element.EnumerateObject())
    {
        var childSchema = Schema?.Properties?.GetValueOrDefault(prop.Name);
        var label = childSchema?.Title ?? HumanizePropertyName(prop.Name);

        @if (prop.Value.ValueKind is JsonValueKind.String or JsonValueKind.Number
             or JsonValueKind.True or JsonValueKind.False)
        {
            <div><strong>@(label):</strong> @FormatScalar(prop.Value)</div>
        }
        else if (prop.Value.ValueKind == JsonValueKind.Null)
        {
            // Skip null values for cleaner display
        }
        else if (prop.Value.ValueKind == JsonValueKind.Array)
        {
            @if (IsStringArray(prop.Value))
            {
                @if (prop.Value.GetArrayLength() <= 10 && IsBadgeCandidate(prop.Name))
                {
                    <div style="margin-top:0.3rem;">
                        <strong>@(label):</strong>
                        <span style="display:inline-flex; flex-wrap:wrap; gap:0.3rem; margin-left:0.3rem;">
                            @foreach (var item in prop.Value.EnumerateArray())
                            {
                                <FluentBadge Appearance="Appearance.Neutral">@item.GetString()</FluentBadge>
                            }
                        </span>
                    </div>
                }
                else if (prop.Value.GetArrayLength() > 0)
                {
                    <div><strong>@(label):</strong></div>
                    <ul style="margin-left:0.5rem;">
                        @foreach (var item in prop.Value.EnumerateArray())
                        {
                            <li>@item.GetString()</li>
                        }
                    </ul>
                }
            }
            else if (prop.Value.GetArrayLength() > 0)
            {
                <div><strong>@(label):</strong></div>
                <div style="padding-left:1rem;">
                    <DynamicSection Element="@prop.Value" Schema="@childSchema" PropertyName="@prop.Name" />
                </div>
            }
        }
        else if (prop.Value.ValueKind == JsonValueKind.Object)
        {
            <div style="margin-top:0.3rem;">
                <strong>@(label):</strong>
                <div style="padding-left:1.2rem; margin-top:0.2rem; border-left:2px solid var(--neutral-stroke-rest);">
                    <DynamicObject Element="@prop.Value" Schema="@childSchema" />
                </div>
            </div>
        }
    }
}

@code {
    [Parameter] public JsonElement Element { get; set; }
    [Parameter] public SchemaNode? Schema { get; set; }

    private static bool IsStringArray(JsonElement arr) =>
        arr.GetArrayLength() > 0 && arr[0].ValueKind == JsonValueKind.String;

    private static bool IsBadgeCandidate(string propName) =>
        propName is "tags" or "creators" or "dependsOn" or "sensitiveData"
        or "phases" or "lifecycles" or "omniborId" or "swhid";

    private static string HumanizePropertyName(string name)
    {
        var result = Regex.Replace(name, "([a-z])([A-Z])", "$1 $2");
        result = result.Replace("-", " ").Replace("_", " ");
        return System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(result);
    }

    private static string FormatScalar(JsonElement el) => el.ValueKind switch
    {
        JsonValueKind.String => el.GetString() ?? "",
        JsonValueKind.Number => el.GetRawText(),
        JsonValueKind.True => "true",
        JsonValueKind.False => "false",
        _ => el.GetRawText()
    };
}

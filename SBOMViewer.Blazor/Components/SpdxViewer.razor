@using SBOMViewer.Blazor.Models.Spdx
@using Microsoft.FluentUI.AspNetCore.Components

@code {
    [Parameter] public SpdxDocument? Document { get; set; }
    [Parameter] public string? DocumentFileName { get; set; }

    private string fileSearch = string.Empty;
    private string packageSearch = string.Empty;
}

@if (Document != null)
{
    <FluentCard Style="background-color:var(--neutral-layer1); color:var(--neutral-foreground-rest); padding:1rem;">
        <!-- Document Filename Centered -->
        <div style="display:flex; align-items:center; justify-content:center; gap:0.5rem; margin-bottom:1rem;">
            <FluentIcon Value="@(new Icons.Regular.Size24.DocumentTextExtract())" />
            <span style="font-weight:bold; font-size:1.1rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
                  title="@DocumentFileName">
                @DocumentFileName
            </span>
        </div>

        <FluentAccordion>

            <!-- General Information -->
            <FluentAccordionItem Expanded="true">
                <HeadingTemplate>
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                        <FluentIcon Value="@(new Icons.Regular.Size24.Info())" />
                        <span>General Information</span>
                    </div>
                </HeadingTemplate>
                <ChildContent>
                    <div class="info-container">
                        <div><span><strong>Name:</strong> @Document.Name </span></div>
                        <div><span><strong>SPDX Version:</strong> @Document.SpdxVersion</span></div>
                        <div><span><strong>Data License:</strong> @Document.DataLicense</span></div>
                        <div><span><strong>Document Namespace:</strong> @Document.DocumentNamespace</span></div>
                    </div>
                </ChildContent>
            </FluentAccordionItem>

            <!-- Creation Information -->
            <FluentDivider />
            <FluentAccordionItem Expanded="true">
                <HeadingTemplate>
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                        <FluentIcon Value="@(new Icons.Regular.Size24.Tab())" />
                        <span>Creation Information</span>
                    </div>
                </HeadingTemplate>
                <ChildContent>
                    <div class="info-container">
                        <div><span><strong>Created:</strong> @Document.CreationInfo.Created</span></div>
                        <div><span><strong>Creators:</strong></span></div>
                        <ul>
                            @foreach (var creator in Document.CreationInfo.Creators)
                            {
                                <li>@creator</li>
                            }
                        </ul>
                    </div>
                </ChildContent>
            </FluentAccordionItem>

            <!-- Files-->
            <FluentDivider />
            <FluentAccordionItem>
                <HeadingTemplate>
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                        <FluentIcon Value="@(new Icons.Regular.Size24.Layer())" />
                        <span>Files | @Document.Files.Count()</span>
                    </div>
                </HeadingTemplate>
                <ChildContent>
                    <!-- Search Input -->
                    <FluentSearch @bind-Value="fileSearch" Style="width:100%" Placeholder="Search file" AutoComplete="off" />

                    <div style="display:flex; align-items:center; gap:0.5rem;">
                        @foreach (var file in Document.Files
                                            .Where(f => string.IsNullOrWhiteSpace(fileSearch)
                                            || f.FileName.Contains(fileSearch, StringComparison.OrdinalIgnoreCase))
                                            .OrderBy(f => f.FileName))
                        {
                            <details>
                                <summary>@file.FileName</summary>
                                <div><span><strong>Spx Id: </strong> @file.SpdxId</span></div>
                                <div><span><strong>License Concluded:</strong> @file.LicenseConcluded</span></div>
                                <div><span><strong>Copyright:</strong> @file.CopyrightText</span></div>
                                <div><span><strong>Checksums</strong></span></div>
                                <ul>
                                    @foreach (var checksum in file.Checksums)
                                    {
                                        <li>@checksum.Algorithm: @checksum.ChecksumValue</li>
                                    }
                                </ul>
                            </details>
                        }
                    </div>
                </ChildContent>
            </FluentAccordionItem>

            <!-- Packages-->
            <FluentDivider />
            <FluentAccordionItem>
                <HeadingTemplate>
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                        <FluentIcon Value="@(new Icons.Regular.Size24.Box())" />
                        <span>Packages | @Document.Packages.Count()</span>
                    </div>
                </HeadingTemplate>
                <ChildContent>
                    <!-- Search input -->
                    <FluentSearch @bind-Value="packageSearch" Placeholder="Search packages" AutoComplete="off" Style="width:100%" />

                    <div class="scroll-container" style="max-height:400px; overflow-y:auto; padding-right:0.5rem;">
                        @foreach (var package in Document.Packages
                                            .Where(p => string.IsNullOrWhiteSpace(packageSearch)
                                            || p.Name.Contains(packageSearch, StringComparison.OrdinalIgnoreCase))
                                            .OrderBy(p => p.Name))
                        {
                            <details>
                                <summary>@package.Name (@package.VersionInfo)</summary>
                                <div><span><strong>SpdxId:</strong> @package.SpdxId</span></div>
                                <div><span><strong>Version:</strong> @package.VersionInfo</span></div>
                                <div><span><strong>FilesAnalyzed:</strong> @package.FilesAnalyzed</span></div>
                                <div><span><strong>LicenseConcluded:</strong> @package.LicenseConcluded</span></div>
                                <div><span><strong>LicenseDeclared:</strong> @package.LicenseDeclared</span></div>
                                <div><span><strong>CopyrightText:</strong> @package.CopyrightText</span></div>
                                <div><span><strong>Supplier:</strong> @package.Supplier</span></div>
                                <div><span><strong>Download Location:</strong> @package.DownloadLocation</span></div>
                                <ul>
                                    @if (package.ExternalReferences != null)
                                    {
                                        @foreach (var extRef in package.ExternalReferences)
                                        {
                                            <li>@extRef.ReferenceType | @extRef.ReferenceCategory (@extRef.ReferenceLocator)</li>
                                        }
                                    }
                                </ul>
                            </details>
                        }
                    </div>
                </ChildContent>
            </FluentAccordionItem>

            <!-- Relationships-->
            <FluentDivider />
            <FluentAccordionItem>
                <HeadingTemplate>
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                        <FluentIcon Value="@(new Icons.Regular.Size24.Link())" />
                        <span>Relationships | @Document.Packages.Count()</span>
                    </div>
                </HeadingTemplate>
                <ChildContent>
                    <div class="scroll-container" style="max-height:400px; overflow-y:auto; padding-right:0.5rem;">
                        @foreach (var relationship in Document.Relationships)
                        {
                            <details>
                                <summary>@relationship.SpdxElementId</summary>
                                <div><span>@relationship.RelationshipType â†’ @relationship.RelatedSpdxElement</span></div>
                            </details>
                        }
                    </div>
                </ChildContent>
            </FluentAccordionItem>
        </FluentAccordion>
    </FluentCard>
}


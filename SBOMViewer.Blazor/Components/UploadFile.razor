@using System.Text.Json
@inject SbomState SbomState
@inject SchemaService SchemaService

<!-- Container -->
<FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center" Style="max-width:800px; margin:auto; padding:1rem; gap:0.5rem;">

    <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.Center" Style="gap:1rem;">
        <!-- File Upload -->
        <FluentInputFile AnchorId="MyUploadStream"
                         DragDropZoneVisible="false"
                         Mode="InputFileMode.Stream"
                         Multiple="false"
                         MaximumFileSize="@(20 * 1024 * 1024)"
                         Accept=".json"
                         OnCompleted="@OnCompleted" />

        <FluentButton Appearance="Appearance.Accent" Id="MyUploadStream">
            Upload SBOM
        </FluentButton>
    </FluentStack>

    <!-- Supported formats -->
    <div style="display:flex; justify-content:center; gap:0.4rem; flex-wrap:wrap;">
        <span style="font-size:0.8rem; color:var(--neutral-foreground-hint);">Supported:</span>
        @foreach (var version in SbomFormatDetector.SupportedVersions)
        {
            <FluentBadge Appearance="Appearance.Neutral" Style="font-size:0.75rem;">@version</FluentBadge>
        }
    </div>
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div style="text-align:center; padding:0.5rem;">
            <FluentBadge Appearance="Appearance.Lightweight" Color="Color.Error">@errorMessage</FluentBadge>
        </div>
    }
</FluentStack>


@if (isLoading)
{
    <div style="
                position:fixed;
                top:0; left:0; right:0; bottom:0;
                background-color:rgba(0,0,0,0.5);
                display:flex;
                justify-content:center;
                align-items:center;
                z-index:1000;">
        <FluentProgress Min="0" Max="100" Value="0" IsIndeterminate="true" />
        <span style="color:white; margin-left:1rem;">Loading SBOM...</span>
    </div>
}

@code {

    private bool isLoading = false;
    private string? errorMessage;

    async Task OnCompleted(IEnumerable<FluentInputFileEventArgs> files)
    {
        if (files == null || !files.Any()) return;

        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        foreach (var file in files)
        {
            if (file?.Stream == null) continue;

            using var reader = new StreamReader(file.Stream);
            string content = await reader.ReadToEndAsync();

            var result = SbomFormatDetector.DetectWithDetails(content);

            if (result.IsUnsupportedVersion)
            {
                errorMessage = $"Version \"{result.DetectedVersion}\" is not supported. Supported versions: {string.Join(", ", SbomFormatDetector.SupportedVersions)}.";
                SbomState.Clear();
            }
            else if (result.Format == null)
            {
                errorMessage = "Unrecognized SBOM format. Please upload a valid CycloneDX or SPDX JSON file.";
                SbomState.Clear();
            }
            else
            {
                try
                {
                    var jsonDoc = JsonDocument.Parse(content, new JsonDocumentOptions
                    {
                        CommentHandling = JsonCommentHandling.Skip,
                        AllowTrailingCommas = true
                    });

                    // Lightweight validation of required fields
                    var validationError = SbomFormatDetector.Validate(jsonDoc.RootElement, result.Format.Value);
                    if (validationError != null)
                    {
                        errorMessage = validationError;
                        jsonDoc.Dispose();
                        SbomState.Clear();
                    }
                    else
                    {
                        var schema = SchemaService.BuildFromJson(jsonDoc.RootElement);
                        SbomState.Schema = schema;
                        SbomState.DetectedFormat = result.Format;
                        SbomState.FileName = file.Name;
                        SbomState.Document = jsonDoc; // Triggers notification
                    }
                }
                catch (JsonException)
                {
                    errorMessage = "Failed to parse JSON content.";
                    SbomState.Clear();
                }
            }
        }

        isLoading = false;
        StateHasChanged();
    }
}
